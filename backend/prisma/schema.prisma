// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String // bcrypt hashed
  name      String?
  createdAt DateTime @default(now())

  // Study preferences
  maxReviewsPerDay  Int @default(100)
  maxNewCardsPerDay Int @default(10)

  // Badge data (stored as JSON array)
  badges Json @default("[]")

  // Gamification fields
  xp            Int       @default(0)
  level         Int       @default(1)
  xpToNextLevel Int       @default(100)
  title         String    @default("Comatose Newbie")
  currentCombo  Int       @default(0)
  highestCombo  Int       @default(0)
  totalXpEarned Int       @default(0)
  streak        Int       @default(0)
  lastStudyDate DateTime?

  nodes   Node[]
  cards   Card[]
  reviews Review[]
  facts   Fact[]
}

model Node {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name     String
  summary  String?
  module   String? // 'Spinal' | 'Brainstem' | 'Cerebrum' | 'CSF' | 'Clinical' | 'Other'
  parentId String?
  parent   Node?   @relation("NodeHierarchy", fields: [parentId], references: [id])
  children Node[]  @relation("NodeHierarchy")

  tags         String[] // Array of tags
  mainImageUrl String? // URL to primary diagram/image for this node

  // Computed fields (updated by trigger/function)
  nodeStrength Float     @default(0)
  lastReviewed DateTime?

  // Import tracking (for highlighting newly imported nodes)
  importBatchId String?   // Groups nodes from same import session
  importedAt    DateTime? // When the node was imported
  sourceFile    String?   // Original filename (e.g., "Chapter 5.pdf")
  isDismissed   Boolean   @default(false) // User dismissed "new" badge

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  facts  Fact[]
  images NodeImage[]
  cards  Card[]
  steps  NodeStep[]

  // Relationships where this node is the source
  sourceRelationships NodeRelationship[] @relation("SourceNode")
  // Relationships where this node is the target
  targetRelationships NodeRelationship[] @relation("TargetNode")

  @@index([userId, nodeStrength])
  @@index([userId, parentId])
  @@index([userId, module])
  @@index([userId, importBatchId])
  @@index([userId, importedAt])
}

model NodeRelationship {
  id String @id @default(cuid())

  sourceNodeId String
  sourceNode   Node   @relation("SourceNode", fields: [sourceNodeId], references: [id], onDelete: Cascade)

  targetNodeId String
  targetNode   Node   @relation("TargetNode", fields: [targetNodeId], references: [id], onDelete: Cascade)

  relationshipType String // 'prerequisite' | 'compare' | 'part_of' | 'related' | 'pathway'
  notes            String? // Optional explanation
  strength         Int     @default(5) // 0-10 importance (for future use)

  createdAt DateTime @default(now())

  @@index([sourceNodeId])
  @@index([targetNodeId])
  @@index([relationshipType])
}

model NodeStep {
  id     String @id @default(cuid())
  nodeId String
  node   Node   @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  stepNumber Int // Order in the sequence (1, 2, 3...)
  title      String // Step title (e.g., "Check pupillary light reflex")
  content    String // Detailed instructions/description

  // Decision/branching support
  decisionPoint Boolean @default(false) // Is this a decision point?
  nextSteps     Json? // Array of {condition: string, nextStepNumber: int}

  // Optional media
  imageUrl String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([nodeId, stepNumber])
  @@index([nodeId, stepNumber])
}

model Fact {
  id     String  @id @default(cuid())
  userId String
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  nodeId String? // null = unsorted
  node   Node?   @relation(fields: [nodeId], references: [id], onDelete: SetNull)

  originalText String @db.Text // Raw note from user
  cleanedText  String @db.Text // AI-cleaned atomic fact
  factType     String // definition/process/localization/comparison/clinical/association
  confidence   Float // 0.0-1.0 confidence from AI

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variants CardVariant[]
  images   FactImage[]
  Card     Card[]

  @@index([userId, nodeId])
  @@index([userId, createdAt])
}

model CardVariant {
  id     String @id @default(cuid())
  factId String
  fact   Fact   @relation(fields: [factId], references: [id], onDelete: Cascade)

  kind       String // basic, cloze, explain
  front      String @db.Text
  back       String @db.Text
  confidence Float // 0.0-1.0 confidence from AI generation

  // FSRS scheduling fields
  due           DateTime @default(now())
  stability     Float    @default(0)
  difficulty    Float    @default(0)
  elapsedDays   Int      @default(0)
  scheduledDays Int      @default(0)
  reps          Int      @default(0)
  lapses        Int      @default(0)
  state         Int      @default(0) // 0=New, 1=Learning, 2=Review, 3=Relearning

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews Review[]

  @@index([factId])
  @@index([due])
}

model Card {
  id     String  @id @default(cuid())
  userId String
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  nodeId String
  node   Node    @relation(fields: [nodeId], references: [id], onDelete: Cascade)
  factId String?
  fact   Fact?   @relation(fields: [factId], references: [id], onDelete: Cascade)

  front String
  back  String
  hint  String?

  // Card type
  cardType String // basic, reverse, cloze, image_occlusion

  // FSRS scheduling data (stored as JSON)
  fsrsData Json // { due, stability, difficulty, elapsed_days, scheduled_days, reps, lapses, state }

  // Images
  frontImageId String?
  backImageId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reviews Review[]

  @@index([userId, nodeId])
}

model Review {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Support both old Card and new CardVariant models
  cardId        String?
  card          Card?        @relation(fields: [cardId], references: [id], onDelete: Cascade)
  cardVariantId String?
  cardVariant   CardVariant? @relation(fields: [cardVariantId], references: [id], onDelete: Cascade)

  rating        Int // 0 = Again, 1 = Hard, 2 = Good, 3 = Easy
  grade         Float // 0, 0.4, or 1.0 (for NodeStrength calculation)
  xpEarned      Int   @default(0)
  comboAtReview Int   @default(0)

  reviewedAt DateTime @default(now())

  @@index([userId, cardId])
  @@index([userId, cardVariantId])
  @@index([reviewedAt])
}

model NodeImage {
  id     String @id @default(cuid())
  nodeId String
  node   Node   @relation(fields: [nodeId], references: [id], onDelete: Cascade)

  filename  String
  url       String // URL or path to image
  imageType String // base, annotated, variant

  // Optional: store image data directly in DB (for MVP)
  imageData Bytes?

  createdAt DateTime @default(now())
}

model FactImage {
  id     String @id @default(cuid())
  factId String
  fact   Fact   @relation(fields: [factId], references: [id], onDelete: Cascade)

  filename  String
  url       String
  imageType String
  imageData Bytes?

  createdAt DateTime @default(now())
}
